package client;

import java.io.IOException;
import java.net.DatagramPacket;
import java.net.DatagramSocket;
import java.net.InetAddress;
import java.net.SocketException;
import java.net.UnknownHostException;
import java.util.Scanner;

public class Chat {
	private int port;
	private int portConect;
	private String name;
	Scanner sc;
	private DatagramSocket socket;
	byte[] buffer = new byte[60000];
	DatagramPacket incoming;
	DatagramPacket outsending;
	InetAddress addrConect;

	public Chat(int port, int portConect) {
		this.port = port;
		this.portConect = portConect;
		sc = new Scanner(System.in);
		try {
			addrServer = InetAddress.getByName("localhost");
		} catch (UnknownHostException e1) {
			// TODO Auto-generated catch block
			e1.printStackTrace();
		}
		// tao socket
		try {
			socket = new DatagramSocket(port);
		} catch (SocketException e) {
			// TODO Auto-generated catch block
			System.out.println("Socket Errors");
		}
	}

	public void start() {
		System.out.println("Nhập tên của bạn: ");
		name = sc.nextLine();
		// thread Receive
		ReceiveClient receiveServer = new ReceiveClient();
		receiveServer.start();

		// thread send
		SendClient sendServer = new SendClient();
		sendServer.start();

		System.out.println("Chat is running...");
	}

	public class ReceiveClient extends Thread {
		@Override
		public void run() {
			while (true) {
				try {
					incoming = new DatagramPacket(buffer, buffer.length);
					// Chờ nhận gói tin gởi đến
					socket.receive(incoming);
					String msg = new String(incoming.getData(), 0, incoming.getLength());
					System.out.println(msg);
				} catch (IOException e) {
					System.out.println("Receive Errors");
				}
			}
		}
	}

	public class SendClient extends Thread {
		@Override
		public void run() {
			while (true) {
				// Tạo gói tin gởi chứa dữ liệu vừa nhận được
				String msgSend = name + ": "+ sc.nextLine();
				if(msgSend.equals("exit"))
					break;
				outsending = new DatagramPacket(msgSend.getBytes(), msgSend.length(), addrServer, portServer);
				// gửi
				try {
					socket.send(outsending);
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			}
		}
	}

	public static void main(String[] args) {
		Chat server = new Chat(8080, 8000);
		server.start();
	}
}
